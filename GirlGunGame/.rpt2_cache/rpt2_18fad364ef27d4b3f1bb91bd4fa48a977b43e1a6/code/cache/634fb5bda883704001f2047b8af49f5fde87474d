{
  "code": "import { ui } from \"./../../../ui/layaMaxUI\";\r\nimport Game from \"../../../game/Game\";\r\nimport GameBG from \"../../../game/GameBG\";\r\nimport Rocker from \"../../../game/GameRocker\";\r\nimport GameMap0 from \"../../../game/GameMap0\";\r\nimport GamePro from \"../../../game/GamePro\";\r\nimport GridType from \"../../../game/bg/GridType\";\r\nimport GameExecut from \"../../../game/GameExecut\";\r\nimport GameCameraNum from \"../../../game/GameCameraNum\";\r\nimport App from \"../../../core/App\";\r\nimport Monster from \"../../../game/player/Monster\";\r\nimport Hero from \"../../../game/player/Hero\";\r\nimport TopUI from \"./TopUI\";\r\nimport PauseUI from \"./PauseUI\";\r\nimport GameOverView from \"./gameOver/GameOverView\";\r\nimport CustomShaderff00 from \"../../../shader/CustomShaderff00\";\r\nimport SelectNewSkill from \"./SelectNewSkill\";\r\nimport Session from \"../../Session\";\r\nimport RebornView from \"./gameOver/RebornView\";\r\nimport GameCube from \"./GameCube\";\r\nimport GameFence from \"./GameFence\";\r\nimport GameEvent from \"../../GameEvent\";\r\nimport GameThorn from \"../../../game/GameThorn\";\r\nimport BattleFlagID from \"../BattleFlagID\";\r\nimport GuideTalk from \"../../guide/GuideTalk\";\r\nimport GuideActionArea from \"../../guide/GuideActionArea\";\r\nimport LvUpView from \"./gameOver/LvUpView\";\r\nimport LogType from \"../../../core/manager/LogType\";\r\nexport default class BattleScene extends Laya.Sprite {\r\n    constructor() {\r\n        super();\r\n        this.npcViewDic = {};\r\n        this.nullGridList = [];\r\n        var bg = new GameBG();\r\n        this.addChild(bg);\r\n        Game.bg = bg;\r\n        var map0 = new GameMap0();\r\n        Game.map0 = map0;\r\n        this.addChild(Game.footLayer);\r\n        Game.footLayer.cacheAs = \"bitmap\";\r\n        var scene = this.addChild(new Laya.Scene3D());\r\n        scene.addChild(Game.layer3d);\r\n        Game.scene3d = scene;\r\n        scene.addChild(Game.layer3dCube);\r\n        scene.addChild(Game.layer3dCoins);\r\n        this.addChild(Game.bloodLayer);\r\n        this.addChild(Game.topLayer);\r\n        var camera = (scene.addChild(new Laya.Camera(0, 0.1, 100)));\r\n        Game.cameraCN = new GameCameraNum(-45, 10);\r\n        camera.transform.translate(new Laya.Vector3(0, Game.cameraCN.y, Game.cameraCN.z));\r\n        camera.transform.rotate(new Laya.Vector3(Game.cameraCN.a, 0, 0), true, false);\r\n        camera.orthographic = true;\r\n        Game.camera = camera;\r\n        GameBG.orthographicVerticalSize = GameBG.wnum * Laya.stage.height / Laya.stage.width;\r\n        camera.orthographicVerticalSize = GameBG.orthographicVerticalSize;\r\n        camera.clearFlag = Laya.BaseCamera.CLEARFLAG_DEPTHONLY;\r\n        var directionLight = scene.addChild(new Laya.DirectionLight());\r\n        directionLight.color = new Laya.Vector3(0.6, 0.6, 0.6);\r\n        directionLight.transform.worldMatrix.setForward(new Laya.Vector3(1, -1, 0));\r\n        this._top = new TopUI();\r\n        this.addChild(this._top);\r\n        this._top.zanting.clickHandler = new Laya.Handler(this, this.showPause);\r\n        Laya.stage.on(Game.Event_SELECT_NEWSKILL, this, this.onShowSelect);\r\n        Laya.stage.on(Game.Event_MAIN_DIE, this, this.showDieView1);\r\n        Laya.stage.on(GameEvent.PASS_CHAPTER, this, this.onOver);\r\n        Laya.stage.on(GameEvent.LV_UP_VIEW, this, this.onLvup);\r\n        Laya.stage.on(GameEvent.LV_UP_VIEW_2, this, this.onLvup2);\r\n        Laya.stage.on(GameEvent.MEMORY_WARNING, this, this.onRelease);\r\n        Laya.stage.on(Game.Event_NPC, this, this.showNpcView);\r\n    }\r\n    onLvup2() {\r\n        this._gameOver && this._gameOver.updateExp();\r\n    }\r\n    onLvup() {\r\n        if (!this._lvupView) {\r\n            this._lvupView = new LvUpView();\r\n        }\r\n        this.addChild(this._lvupView);\r\n    }\r\n    onRelease() {\r\n        Game.battleLoader.onRelease();\r\n    }\r\n    onShowSelect(lv) {\r\n        if (lv > 10) {\r\n            return;\r\n        }\r\n        this.up(null);\r\n        if (!this._selectSkill) {\r\n            this._selectSkill = new SelectNewSkill();\r\n        }\r\n        this.addChild(this._selectSkill);\r\n        Game.isPopupSkill = 1;\r\n        Game.state = 1;\r\n    }\r\n    onOver() {\r\n        if (!this._gameOver) {\r\n            this._gameOver = new GameOverView();\r\n        }\r\n        this.addChild(this._gameOver);\r\n        Game.state = 1;\r\n    }\r\n    onReborn() {\r\n        if (!this._rebornView) {\r\n            this._rebornView = new RebornView();\r\n        }\r\n        this.addChild(this._rebornView);\r\n        Game.state = 1;\r\n    }\r\n    showDieView1() {\r\n        if (Game.rebornTimes <= 0) {\r\n            this.onOver();\r\n        }\r\n        else {\r\n            this.onReborn();\r\n        }\r\n    }\r\n    showPause() {\r\n        if (!this._pauseUI) {\r\n            this._pauseUI = new PauseUI();\r\n        }\r\n        this.addChild(this._pauseUI);\r\n        Game.executor.stop_();\r\n        Game.state = 1;\r\n    }\r\n    showNpcView() {\r\n        this.up(null);\r\n        let npcId = Game.bg.npcId;\r\n        console.log(\"显示npc\", npcId);\r\n        if (npcId > 0) {\r\n            if (this.npcViewDic[npcId] == null) {\r\n                let NPCVIEW = Laya.ClassUtils.getClass(\"NPCVIEW\" + npcId);\r\n                if (NPCVIEW) {\r\n                    this.npcViewDic[npcId] = new NPCVIEW();\r\n                }\r\n            }\r\n            this.addChild(this.npcViewDic[npcId]);\r\n            Game.state = 1;\r\n        }\r\n    }\r\n    init() {\r\n        Session.homeData.isPass = false;\r\n        BattleScene.npcPro = null;\r\n        this._top.reset();\r\n        if (!Game.hero) {\r\n            Hero.udpateHeroData();\r\n            Game.hero = new Hero();\r\n        }\r\n        GameFence.recover();\r\n        GameThorn.recover();\r\n        Session.saveData();\r\n        Game.reset();\r\n        this._top.updateCoins();\r\n        this._top.updateExp();\r\n        this._top.updateIndex(Game.battleLoader.index);\r\n        if (!Game.executor) {\r\n            Game.executor = new GameExecut();\r\n            CustomShaderff00.ff00;\r\n        }\r\n        this._top._indexBox.visible = !Session.homeData.isGuide;\r\n        this._top.zanting.visible = !Session.homeData.isGuide;\r\n        Game.map0.drawMap();\r\n        GameBG.mcx = 13 * GameBG.ww / 2 - GameBG.mw2;\r\n        GameBG.mcy = GameBG.bgHH * 0.5 - GameBG.mw2;\r\n        Game.setSelectEffect();\r\n        var aa = Laya.loader.getRes(\"h5/zhalan/hero.lh\");\r\n        Game.fence = aa;\r\n        this.nullGridList.length = 0;\r\n        let sp;\r\n        var isHasBoss = false;\r\n        var bossEnemy;\r\n        var monster;\r\n        let k = 0;\r\n        for (let j = 0; j < GameBG.MAP_ROW; j++) {\r\n            for (let i = 0; i < GameBG.MAP_COL; i++) {\r\n                let type = GameBG.arr0[k];\r\n                if (GridType.isCube(type)) {\r\n                    GameCube.getOne(GameBG.get3D(i, j), type);\r\n                }\r\n                else if (GridType.isFence(type)) {\r\n                    GameFence.getOne(GameBG.get3D(i, j));\r\n                }\r\n                else if (GridType.isNpc(type)) {\r\n                    BattleScene.npcPro = new GamePro(0, 1);\r\n                    BattleScene.npcPro.setSp3d(null, GameBG.ww * 0.8);\r\n                    BattleScene.npcPro.setXY2DBox(GameBG.ww * i + (GameBG.ww - GameBG.mw) / 2, j * GameBG.ww + (GameBG.ww - GameBG.mw) / 2);\r\n                }\r\n                else if (Game.battleLoader.continueRes == null && GridType.isMonster(type)) {\r\n                    if (Game.battleLoader.monsterId > 0) {\r\n                        type = Game.battleLoader.monsterId;\r\n                    }\r\n                    monster = Monster.getMonster(type, GameBG.ww * i + (GameBG.ww - GameBG.mw) / 2, j * GameBG.ww + (GameBG.ww - GameBG.mw) / 2);\r\n                    monster.splitTimes = 1;\r\n                    if (!isHasBoss) {\r\n                        isHasBoss = monster.sysEnemy.isBoss == 1;\r\n                        bossEnemy = monster.sysEnemy;\r\n                    }\r\n                    if (Session.homeData.isGuide) {\r\n                        this.guideMonster = monster;\r\n                        this.guideMonster.hide();\r\n                    }\r\n                }\r\n                if (type == BattleFlagID.DOOR) {\r\n                    let v3 = GameBG.get3D(i, j);\r\n                    if (!Game.door) {\r\n                        Game.door = Laya.loader.getRes(\"h5/effects/door/monster.lh\");\r\n                        Game.layer3d.addChild(Game.door);\r\n                        Game.door.transform.translate(v3);\r\n                    }\r\n                    Game.door.transform.localPositionX = v3.x;\r\n                    Game.door.transform.localPositionZ = v3.z;\r\n                }\r\n                else if (type == BattleFlagID.GUIDE) {\r\n                    let v3 = GameBG.get3D(i, j);\r\n                    this.guideCircle = Laya.loader.getRes(\"h5/effects/guide/monster.lh\");\r\n                    this.guideCircle.transform.translate(v3);\r\n                    this.guideCircle.transform.localPositionX = v3.x;\r\n                    this.guideCircle.transform.localPositionZ = v3.z;\r\n                }\r\n                k++;\r\n            }\r\n        }\r\n        this._top.setBoss(isHasBoss, bossEnemy);\r\n        Game.closeDoor();\r\n        if (monster) {\r\n            monster.hurt(0, false);\r\n            Game.e0_ = monster;\r\n        }\r\n        Game.bg.drawR(isHasBoss);\r\n        Game.ro = new Rocker();\r\n        Game.ro.resetPos();\r\n        this.addChild(Game.ro);\r\n        Game.hero.init();\r\n        Game.lastLevel = Game.level;\r\n        Game.bg.updateY();\r\n        if (BattleScene.npcPro) {\r\n            Game.dropDiamond(BattleScene.npcPro);\r\n        }\r\n        this.setGuide(\"滑动摇杆，控制角色到达指定位置。\", 1);\r\n        App.sdkManager.log(LogType.BATTLE_GUIDE, \"滑动摇杆，控制角色到达指定位置。\");\r\n        Laya.MouseManager.multiTouchEnabled = false;\r\n        Laya.stage.on(Laya.Event.MOUSE_DOWN, this, this.md);\r\n        Laya.stage.on(Laya.Event.KEY_PRESS, this, this.onOpenDoor);\r\n    }\r\n    setGuide(str, guideId) {\r\n        this._guideTalk && this._guideTalk.removeSelf();\r\n        if (!Session.homeData.isGuide) {\r\n            return;\r\n        }\r\n        Session.guideId = guideId;\r\n        if (!this._guideTalk) {\r\n            this._guideTalk = new GuideTalk();\r\n        }\r\n        this.addChild(this._guideTalk);\r\n        this._guideTalk.setContent(str, guideId);\r\n        Laya.stage.on(GameEvent.SHOW_ACTION_RECT, this, this.showActionRect);\r\n    }\r\n    showActionRect(guideId) {\r\n        this._guideArea && this._guideArea.removeSelf();\r\n        if (!Session.homeData.isGuide) {\r\n            return;\r\n        }\r\n        if (Session.guideId == 1) {\r\n            if (!this._guideArea) {\r\n                this._guideArea = new GuideActionArea();\r\n            }\r\n            this.addChild(this._guideArea);\r\n            this._guideArea.y = Laya.stage.height - this._guideArea.height;\r\n            Game.layer3d.addChild(this.guideCircle);\r\n            Session.guideId = 3;\r\n            App.sdkManager.log(LogType.BATTLE_GUIDE, \"最佳控制区域\");\r\n        }\r\n        else if (Session.guideId == 2) {\r\n            let zhaohuan = new ui.test.zhaohuanUI();\r\n            Game.bloodLayer.addChild(zhaohuan);\r\n            zhaohuan.pos(this.guideMonster.hbox.cx, this.guideMonster.hbox.cy);\r\n            setTimeout(() => {\r\n                zhaohuan.removeSelf();\r\n                this.guideMonster.show();\r\n                Session.guideId = 4;\r\n                this.guideCircle && this.guideCircle.removeSelf();\r\n                App.sdkManager.log(LogType.BATTLE_GUIDE, \"显示引导怪\");\r\n            }, 800);\r\n        }\r\n    }\r\n    onOpenDoor(e) {\r\n        if (e.nativeEvent.keyCode == 111) {\r\n            Game.hero.busi = true;\r\n        }\r\n    }\r\n    kd(eve) {\r\n        if (Game.executor.isRun) {\r\n            Game.executor.stop_();\r\n        }\r\n        else {\r\n            Game.executor.start();\r\n        }\r\n    }\r\n    md(eve) {\r\n        if (Game.state > 0) {\r\n            return;\r\n        }\r\n        if (Session.guideId == 1 || Session.guideId == 2) {\r\n            return;\r\n        }\r\n        Laya.stage.off(Laya.Event.MOUSE_DOWN, this, this.md);\r\n        Laya.stage.on(Laya.Event.MOUSE_UP, this, this.up);\r\n        let xx = Laya.stage.mouseX;\r\n        let yy = Laya.stage.mouseY;\r\n        Game.ro.x = xx;\r\n        Game.ro.y = yy;\r\n        this.addChild(Game.ro);\r\n        Laya.stage.frameLoop(1, this, this.moves);\r\n        if (Game.executor.isRun) {\r\n            Game.hero.getGameAi().run = true;\r\n        }\r\n    }\r\n    up(eve) {\r\n        Laya.stage.off(Laya.Event.MOUSE_UP, this, this.up);\r\n        Laya.stage.on(Laya.Event.MOUSE_DOWN, this, this.md);\r\n        if (Game.ro && Game.ro.parent) {\r\n            Game.ro.resetPos();\r\n            Game.ro.reset();\r\n        }\r\n        Laya.stage.clearTimer(this, this.moves);\r\n        if (Game.executor.isRun) {\r\n            Game.hero.getGameAi().run = false;\r\n        }\r\n    }\r\n    moves() {\r\n        if (Game.state > 0) {\r\n            return;\r\n        }\r\n        let xx = Laya.stage.mouseX;\r\n        let yy = Laya.stage.mouseY;\r\n        let n;\r\n        Game.ro.setSp0(xx, yy);\r\n    }\r\n}\r\n",
  "references": [
    "D:/GirlGunGame/GirlGunGame/src/ui/layaMaxUI.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/Game.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/GameBG.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/GameRocker.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/GameMap0.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/GameHitBox.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/GamePro.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/bg/GridType.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/GameProType.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/controllerScript/FootRotateScript.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/controllerScript/HeadTranslateScript.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/GameExecut.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/GameCameraNum.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/sys/SysEnemy.ts",
    "D:/GirlGunGame/GirlGunGame/src/core/App.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/ai/AttackType.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/move/MoveType.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/battle/BattleLoader.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/ai/HeroAI.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/player/Monster.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/player/Hero.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/battle/TopUI.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/battle/PauseUI.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/battle/gameOver/GameOverView.ts",
    "D:/GirlGunGame/GirlGunGame/src/shader/CustomShaderff00.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/battle/SelectNewSkill.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/sys/SysSkill.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/Session.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/battle/gameOver/RebornView.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/battle/GameCube.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/battle/GameFence.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/sys/SysMap.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/GameEvent.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/GameThorn.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/BattleFlagID.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/guide/GuideTalk.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/guide/GuideActionArea.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/player/HeroBullet.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/scene/battle/gameOver/LvUpView.ts",
    "D:/GirlGunGame/GirlGunGame/src/core/manager/LogType.ts"
  ]
}
