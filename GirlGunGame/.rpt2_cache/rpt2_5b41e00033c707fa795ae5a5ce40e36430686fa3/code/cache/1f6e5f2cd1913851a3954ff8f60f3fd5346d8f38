{
  "code": "import { BasePlatform } from \"./BasePlatform\";\r\nimport Game from \"../game/Game\";\r\nimport GameEvent from \"../main/GameEvent\";\r\nexport default class WXPlatform extends BasePlatform {\r\n    constructor() {\r\n        super();\r\n        this.tag = 0;\r\n    }\r\n    checkUpdate() {\r\n        Laya.Browser.window.wx.setKeepScreenOn({\r\n            keepScreenOn: true\r\n        });\r\n        if (Laya.Browser.window.wx.getUpdateManager) {\r\n            console.log(\"基础库 1.9.90 开始支持，低版本需做兼容处理\");\r\n            const updateManager = Laya.Browser.window.wx.getUpdateManager();\r\n            updateManager.onCheckForUpdate(function (result) {\r\n                if (result.hasUpdate) {\r\n                    console.log(\"有新版本\");\r\n                    updateManager.onUpdateReady(function () {\r\n                        console.log(\"新的版本已经下载好\");\r\n                        Laya.Browser.window.wx.showModal({\r\n                            title: '更新提示',\r\n                            content: '新版本已经下载，是否重启？',\r\n                            success: function (result) {\r\n                                if (result.confirm) {\r\n                                    updateManager.applyUpdate();\r\n                                }\r\n                            }\r\n                        });\r\n                    });\r\n                    updateManager.onUpdateFailed(function () {\r\n                        console.log(\"新的版本下载失败\");\r\n                        Laya.Browser.window.wx.showModal({\r\n                            title: '已经有新版本了',\r\n                            content: '新版本已经上线啦，请您删除当前小游戏，重新搜索打开'\r\n                        });\r\n                    });\r\n                }\r\n                else {\r\n                    console.log(\"没有新版本\");\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            console.log(\"有更新肯定要用户使用新版本，对不支持的低版本客户端提示\");\r\n            Laya.Browser.window.wx.showModal({\r\n                title: '温馨提示',\r\n                content: '当前微信版本过低，无法使用该应用，请升级到最新微信版本后重试。'\r\n            });\r\n        }\r\n        Laya.Browser.window.wx.onMemoryWarning((res) => {\r\n            console.error(\"内存不足了\", res);\r\n            Laya.stage.event(GameEvent.MEMORY_WARNING);\r\n        });\r\n    }\r\n    login(callback) {\r\n        Laya.Browser.window.wx.login({\r\n            success: (res) => {\r\n                if (res.code) {\r\n                    callback && callback(res.code);\r\n                }\r\n            }\r\n        });\r\n    }\r\n    getUserInfo(callback) {\r\n        if (this.userBtn) {\r\n            return;\r\n        }\r\n        this.userBtn = Laya.Browser.window.wx.createUserInfoButton({\r\n            type: 'text',\r\n            text: '',\r\n            style: {\r\n                width: Laya.Browser.window.wx.getSystemInfoSync().windowWidth,\r\n                height: Laya.Browser.window.wx.getSystemInfoSync().windowHeight\r\n            }\r\n        });\r\n        this.userBtn.onTap((resButton) => {\r\n            if (resButton.errMsg == \"getUserInfo:ok\") {\r\n                Game.userHeadUrl = resButton.userInfo.avatarUrl;\r\n                Game.userName = resButton.userInfo.nickName;\r\n                this.filterEmoji();\r\n                this.userBtn.destroy();\r\n                callback && callback();\r\n            }\r\n            else {\r\n                console.log(\"授权失败\");\r\n            }\r\n        });\r\n    }\r\n    wxAuthSetting() {\r\n        console.log(\"wx.getSetting\");\r\n        Laya.Browser.window.wx.getSetting({\r\n            success: (res) => {\r\n                console.log(res.authSetting);\r\n                var authSetting = res.authSetting;\r\n                if (authSetting[\"scope.userInfo\"]) {\r\n                    console.log(\"已经授权\");\r\n                }\r\n                else {\r\n                    console.log(\"未授权\");\r\n                }\r\n            }\r\n        });\r\n    }\r\n    filterEmoji() {\r\n        var strArr = Game.userName.split(\"\"), result = \"\", totalLen = 0;\r\n        for (var idx = 0; idx < strArr.length; idx++) {\r\n            if (totalLen >= 16)\r\n                break;\r\n            var val = strArr[idx];\r\n            if (/[a-zA-Z]/.test(val)) {\r\n                totalLen = 1 + (+totalLen);\r\n                result += val;\r\n            }\r\n            else if (/[\\u4e00-\\u9fa5]/.test(val)) {\r\n                totalLen = 2 + (+totalLen);\r\n                result += val;\r\n            }\r\n            else if (/[\\ud800-\\udfff]/.test(val)) {\r\n                if (/[\\ud800-\\udfff]/.test(strArr[idx + 1])) {\r\n                    idx++;\r\n                }\r\n                result += \"?\";\r\n            }\r\n        }\r\n        Game.userName = result;\r\n        console.log(\"过滤之后\", Game.userName);\r\n    }\r\n    onShare(callback) {\r\n        Laya.Browser.window.wx.shareAppMessage({\r\n            title: \"来吧，pk一下吧！\",\r\n            imageUrl: \"https://img.kuwan511.com/arrowLegend/share.jpg\",\r\n            destWidth: 500,\r\n            destHeight: 400\r\n        });\r\n        Laya.Browser.window.wx.onShow(res => {\r\n            console.log(\"onShow\", this.tag);\r\n            if (this.tag == 1000) {\r\n                Game.hero.reborn();\r\n                Laya.Browser.window.wx.offShow();\r\n                Laya.Browser.window.wx.offHide();\r\n                this.tag = -1;\r\n            }\r\n        });\r\n        Laya.Browser.window.wx.onHide(res => {\r\n            this.tag = 1000;\r\n            console.log(\"onHide\");\r\n        });\r\n    }\r\n}\r\n",
  "references": [
    "D:/GirlGunGame/GirlGunGame/src/platforms/BasePlatform.ts",
    "D:/GirlGunGame/GirlGunGame/src/game/Game.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/GameEvent.ts"
  ]
}
