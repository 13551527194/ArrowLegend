{
  "code": "import App from \"../App\";\r\nimport GameEvent from \"../../main/GameEvent\";\r\nimport LogType from \"./LogType\";\r\nimport FlyUpTips from \"../../main/FlyUpTips\";\r\nimport { AD_TYPE } from \"../../ADType\";\r\nimport Log from \"../../Log\";\r\nexport default class SdkManager {\r\n    constructor() {\r\n        this.haveRight = false;\r\n        this.wxName = null;\r\n        this.wxHead = null;\r\n        this.adMap = {};\r\n        this.lastAdSucTime = 0;\r\n        this.currentAdType = 0;\r\n        this.adHandler = null;\r\n        this.adStat = 0;\r\n        this.errCode = 0;\r\n        this.shareStartTime = 0;\r\n        this.shareTimes = 0;\r\n        this.shareTime = 0;\r\n        this.bannerArray = [];\r\n        if (Laya.Browser.onMiniGame == false) {\r\n            return;\r\n        }\r\n        Laya.Browser.window.wx.updateShareMenu({});\r\n        Laya.Browser.window.wx.showShareMenu({});\r\n        Laya.Browser.window.wx.onShareAppMessage(() => {\r\n            return this.getShareObject();\r\n        });\r\n        Laya.Browser.window.wx.getSetting({\r\n            success: res => {\r\n                if (res.authSetting[\"scope.userInfo\"] == true) {\r\n                    console.log(\"已经有授权了\");\r\n                    this.getUserInfo();\r\n                }\r\n                else {\r\n                    this.haveRight = false;\r\n                    console.log(\"没有授权\");\r\n                }\r\n            }\r\n        });\r\n        Laya.Browser.window.wx.setKeepScreenOn({ keepScreenOn: true });\r\n        Laya.Browser.window.wx.onShow((res) => {\r\n            App.sendEvent(GameEvent.WX_ON_SHOW);\r\n        });\r\n        Laya.Browser.window.wx.onHide((res) => {\r\n            App.sendEvent(GameEvent.WX_ON_HIDE);\r\n        });\r\n        const updateManager = Laya.Browser.window.wx.getUpdateManager();\r\n        updateManager.onCheckForUpdate(function (res) {\r\n            console.log(\"版本更新回调:\", res.hasUpdate);\r\n        });\r\n        updateManager.onUpdateReady(function () {\r\n            Laya.Browser.window.wx.showModal({\r\n                title: '更新提示',\r\n                content: '新版本已经准备好，是否重启应用？',\r\n                success: function (res) {\r\n                    if (res.confirm) {\r\n                        updateManager.applyUpdate();\r\n                    }\r\n                }\r\n            });\r\n        });\r\n        updateManager.onUpdateFailed(function () {\r\n        });\r\n        let btn = {};\r\n        btn.type = \"image\";\r\n        let sty = {};\r\n        sty.left = 0;\r\n        sty.top = 400;\r\n        sty.width = 44;\r\n        sty.height = 44;\r\n        sty.textAlign = \"center\";\r\n        sty.fontSize = 28;\r\n        sty.lineHeight = 30;\r\n        btn.style = sty;\r\n        btn.icon = \"green\";\r\n        this.gameClubButton = Laya.Browser.window.wx.createGameClubButton(btn);\r\n        Laya.timer.callLater(this, this.callLaterFun);\r\n    }\r\n    getUserInfo() {\r\n        Laya.Browser.window.wx.getUserInfo({\r\n            success: (res) => {\r\n                var userInfo = res.userInfo;\r\n                this.wxName = userInfo.nickName;\r\n                this.wxHead = userInfo.avatarUrl;\r\n                var gender = userInfo.gender;\r\n                var province = userInfo.province;\r\n                var city = userInfo.city;\r\n                var country = userInfo.country;\r\n                console.log(\"已经授权了:\", this.wxName, this.wxHead);\r\n                this.haveRight = true;\r\n            }\r\n        });\r\n    }\r\n    callLaterFun() {\r\n        this.initAd();\r\n    }\r\n    log(type, content = \"\") {\r\n        Log.log(type, content);\r\n    }\r\n    initAd() {\r\n        if (Laya.Browser.onMiniGame) {\r\n            this.adMap[AD_TYPE.AD_REBORTH] = \"adunit-dd859bd89e519faa\";\r\n            this.adMap[AD_TYPE.AD_BATTLE10] = \"adunit-fb55742c910f9809\";\r\n            this.adMap[AD_TYPE.AD_CHANGE_SKILL] = \"adunit-dd78193a76256a8b\";\r\n        }\r\n        this.ad = Laya.Browser.window.wx.createRewardedVideoAd({ adUnitId: this.adMap[AD_TYPE.AD_REBORTH] });\r\n        this.ad.onClose((res) => {\r\n            console.log(\"广告 观看结果返回\");\r\n            if (res && res.isEnded || res === undefined) {\r\n                this.lastAdSucTime = Laya.Browser.now();\r\n                this.exeHandler();\r\n                this.log(LogType.AD_SUC_OVER, this.currentAdType + \"\");\r\n                App.sendEvent(GameEvent.AD_OVER);\r\n            }\r\n        });\r\n        this.ad.onError(err => {\r\n            this.adStat = 2;\r\n            this.errCode = err.errCode;\r\n            console.log(\"广告 加载错误:\", err);\r\n            if (this.errCode == 1004) {\r\n                console.log(\"加载视频失败,30秒后重试\");\r\n                Laya.timer.once(30 * 1000, this, this.retryAdFun);\r\n            }\r\n            this.log(LogType.AD_FAIL, this.errCode + \"\");\r\n        });\r\n        this.ad.onLoad(() => {\r\n            this.adStat = 1;\r\n            console.log(\"广告 加载成功-----------------\");\r\n        });\r\n    }\r\n    retryAdFun() {\r\n        this.ad.load();\r\n    }\r\n    playAdVideo(code, h) {\r\n        this.currentAdType = code;\r\n        if (Laya.Browser.onMiniGame == false) {\r\n            h.runWith(1);\r\n            App.sendEvent(GameEvent.AD_OVER);\r\n            return;\r\n        }\r\n        if (this.adStat == 2 || this.ad == null) {\r\n            this.share2(h);\r\n            return;\r\n        }\r\n        this.adHandler = h;\r\n        let adid = this.adMap[code];\r\n        Laya.Browser.window.wx.createRewardedVideoAd({ adUnitId: adid });\r\n        this.tryShowAD();\r\n    }\r\n    initAdBtn(sp, type) {\r\n        sp.gray = (this.adStat == 2);\r\n        sp.once(Laya.Event.UNDISPLAY, this, this.adUndisFun, [type]);\r\n    }\r\n    adUndisFun(type) {\r\n    }\r\n    tryShowAD() {\r\n        this.log(LogType.AD_SUC);\r\n        this.ad.show().catch(() => {\r\n            this.ad.load().then(() => this.ad.show()).catch(err => {\r\n                console.log('广告再加载失败');\r\n                console.log(err);\r\n                this.adStat = 2;\r\n                this.log(LogType.AD_FAIL_2);\r\n            });\r\n        });\r\n    }\r\n    exeHandler() {\r\n        this.adHandler.runWith(1);\r\n    }\r\n    exeHandler2() {\r\n        this.share(this.adHandler);\r\n    }\r\n    share2(h) {\r\n        var obj = this.getShareObject();\r\n        obj.query = \"\";\r\n        obj.imageUrlId = \"\";\r\n        Laya.Browser.window.wx.shareAppMessage(obj);\r\n        this.shareStartTime = Laya.Browser.now();\r\n        Laya.stage.once(GameEvent.WX_ON_SHOW, this, this.showFun, [h]);\r\n    }\r\n    share(h, type = 0) {\r\n        this.checkShare();\r\n        if (Laya.Browser.onMiniGame == false) {\r\n            this.shareTimes++;\r\n            h.runWith(1);\r\n            return;\r\n        }\r\n        var obj = this.getShareObject();\r\n        obj.query = \"\";\r\n        obj.imageUrlId = \"\";\r\n        Laya.Browser.window.wx.shareAppMessage(obj);\r\n        this.shareStartTime = Laya.Browser.now();\r\n        let chao = this.shareTimes >= SdkManager.SHARE_MAX_TIMES;\r\n        Laya.stage.once(GameEvent.WX_ON_SHOW, this, this.showFun, [chao ? null : h]);\r\n    }\r\n    onlyShare() {\r\n        var obj = this.getShareObject();\r\n        obj.query = \"\";\r\n        Laya.Browser.window.wx.shareAppMessage(obj);\r\n    }\r\n    showFun(h) {\r\n        if (h == null) {\r\n            FlyUpTips.setTips(\"分享成功\");\r\n            return;\r\n        }\r\n        if ((Laya.Browser.now() - this.shareStartTime) > 2000) {\r\n            this.shareTimes++;\r\n            h.runWith(1);\r\n        }\r\n        else {\r\n            FlyUpTips.setTips(\"请分享到不同群获得奖励\");\r\n        }\r\n    }\r\n    checkShare() {\r\n        let now = new Date();\r\n        let last = new Date(this.shareTime);\r\n        if (now.getDate() != last.getDate()) {\r\n            this.shareTimes = 0;\r\n        }\r\n        this.shareTime = Date.now();\r\n    }\r\n    getShareObject() {\r\n        var arr = [\"亲手打造更多的神兵利器，来与恶龙们抗争到底。\", \"只有我一个，我是独一份、我是限量款、我是天选之子。\", \"今年只玩骑马合成冲，对抗恶龙，拯救你的大陆。\"];\r\n        var obj = {};\r\n        obj.title = App.RandomByArray(arr);\r\n        obj.imageUrl = \"https://img.kuwan511.com/arrowLegend/shareImg.jpg\";\r\n        return obj;\r\n    }\r\n    savePlayerData(stageNum) {\r\n        if (Laya.Browser.onMiniGame == false) {\r\n            return;\r\n        }\r\n        var obj = {};\r\n        var o1 = {};\r\n        o1.key = \"stageNum\";\r\n        o1.value = stageNum + \"\";\r\n        obj[\"KVDataList\"] = [o1];\r\n        obj.success = (res) => {\r\n            console.log(\"存储数据成功\", res);\r\n        };\r\n        obj.fail = (res) => {\r\n            console.log(\"失败\", res);\r\n        };\r\n        Laya.Browser.window.wx.setUserCloudStorage(obj);\r\n    }\r\n    showBanner(code) {\r\n        let obj = {};\r\n        obj.adUnitId = code;\r\n        let l = (Laya.Browser.clientWidth - 300) / 2;\r\n        obj.style = { left: l, top: 0, width: 300, height: 125 };\r\n        let b = Laya.Browser.window.wx.createBannerAd(obj);\r\n        b.onResize(res => {\r\n            b.style.top = Laya.Browser.clientHeight - res.height - 20;\r\n        });\r\n        b.show();\r\n        this.bannerArray.push(b);\r\n    }\r\n    hideBanner() {\r\n        for (let i = 0; i < this.bannerArray.length; i++) {\r\n            this.bannerArray[i].hide();\r\n            this.bannerArray[i].destroy();\r\n        }\r\n        this.bannerArray.length = 0;\r\n    }\r\n    addUserInfoBtn(sp, h) {\r\n        var s = Laya.Browser.clientWidth / Laya.stage.width;\r\n        var p = sp.localToGlobal(new Laya.Point(0, 0));\r\n        var btnX = p.x * s;\r\n        var btnY = p.y * s;\r\n        var btnwid = sp.width * s;\r\n        var btnhei = sp.height * s;\r\n        this.userInfoButton = Laya.Browser.window.wx.createUserInfoButton({\r\n            type: 'text',\r\n            text: '',\r\n            style: {\r\n                left: btnX,\r\n                top: btnY,\r\n                width: btnwid,\r\n                height: btnhei,\r\n                lineHeight: 40,\r\n                backgroundColor: '#ffffff00',\r\n                color: '',\r\n                textAlign: 'center',\r\n                fontSize: 16,\r\n                borderRadius: 0,\r\n                borderColor: \"#ffffff\"\r\n            }\r\n        });\r\n        this.userInfoButton.onTap((res) => {\r\n            if (res.errMsg == \"getUserInfo:ok\") {\r\n                this.wxName = res.userInfo.nickName;\r\n                this.wxHead = res.userInfo.avatarUrl;\r\n                this.haveRight = true;\r\n                h.run();\r\n                this.undisFun();\r\n            }\r\n        });\r\n        sp.once(Laya.Event.UNDISPLAY, this, this.undisFun);\r\n    }\r\n    undisFun() {\r\n        if (this.userInfoButton) {\r\n            this.userInfoButton.destroy();\r\n            this.userInfoButton = null;\r\n        }\r\n    }\r\n    chaPingAd(type, handler) {\r\n        if (Laya.Browser.window.wx.createInterstitialAd == null) {\r\n            handler.run();\r\n            return;\r\n        }\r\n        if ((Laya.Browser.now() - this.lastAdSucTime) < 3 * 60 * 1000) {\r\n            handler.run();\r\n            return;\r\n        }\r\n        if (this.canUse(\"2.6.0\") == false) {\r\n            handler.run();\r\n            return;\r\n        }\r\n        let code = this.adMap[type];\r\n        if (code == null) {\r\n            handler.run();\r\n            return;\r\n        }\r\n        let obj = {};\r\n        obj.adUnitId = code;\r\n        let ad = Laya.Browser.window.wx.createInterstitialAd(obj);\r\n        ad.show().catch((err) => {\r\n            console.error(\"插屏广告:\", err);\r\n        });\r\n        ad.onClose(() => {\r\n            handler.run();\r\n        });\r\n    }\r\n    canUse(str) {\r\n        return this.compareVersion(str) >= 0;\r\n    }\r\n    compareVersion(v) {\r\n        let now = Laya.Browser.window.wx.getSystemInfoSync().SDKVersion;\r\n        let v1 = v.split('.');\r\n        let v2 = now.split('.');\r\n        const len = Math.max(v1.length, v2.length);\r\n        while (v1.length < len) {\r\n            v1.push('0');\r\n        }\r\n        while (v2.length < len) {\r\n            v2.push('0');\r\n        }\r\n        for (let i = 0; i < len; i++) {\r\n            const num1 = parseInt(v1[i]);\r\n            const num2 = parseInt(v2[i]);\r\n            if (num1 > num2) {\r\n                return 1;\r\n            }\r\n            else if (num1 < num2) {\r\n                return -1;\r\n            }\r\n        }\r\n        return 0;\r\n    }\r\n}\r\nSdkManager.FLY_BOX = 0;\r\nSdkManager.GAME_OVER = 1;\r\nSdkManager.GET_PET = 2;\r\nSdkManager.TIME_GOLD = 3;\r\nSdkManager.TREASURE = 4;\r\nSdkManager.ZHUAN = 5;\r\nSdkManager.AD_DIALOG = 7;\r\nSdkManager.NEXT_STAGE_CHAPING = 6;\r\nSdkManager.REBORTH = 11;\r\nSdkManager.SHARE_MAX_TIMES = 6;\r\nexport var AD_STAT;\r\n(function (AD_STAT) {\r\n    AD_STAT[AD_STAT[\"DIALOG_OPEN\"] = 0] = \"DIALOG_OPEN\";\r\n    AD_STAT[AD_STAT[\"DIALOG_CLOSE\"] = 1] = \"DIALOG_CLOSE\";\r\n    AD_STAT[AD_STAT[\"VEDIO_CLICK\"] = 2] = \"VEDIO_CLICK\";\r\n    AD_STAT[AD_STAT[\"VEDIO_FAIL\"] = 3] = \"VEDIO_FAIL\";\r\n    AD_STAT[AD_STAT[\"VEDIO_SUC\"] = 4] = \"VEDIO_SUC\";\r\n    AD_STAT[AD_STAT[\"REWARD\"] = 5] = \"REWARD\";\r\n    AD_STAT[AD_STAT[\"NO_HAVE\"] = 6] = \"NO_HAVE\";\r\n})(AD_STAT || (AD_STAT = {}));\r\n",
  "references": [
    "D:/GirlGunGame/GirlGunGame/src/core/App.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/GameEvent.ts",
    "D:/GirlGunGame/GirlGunGame/src/core/manager/LogType.ts",
    "D:/GirlGunGame/GirlGunGame/src/main/FlyUpTips.ts",
    "D:/GirlGunGame/GirlGunGame/src/ADType.ts",
    "D:/GirlGunGame/GirlGunGame/src/Log.ts"
  ]
}
