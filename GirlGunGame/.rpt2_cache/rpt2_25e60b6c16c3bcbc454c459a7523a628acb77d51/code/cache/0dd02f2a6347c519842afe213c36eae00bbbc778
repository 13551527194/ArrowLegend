{
  "code": "import { ui } from \"../../../ui/layaMaxUI\";\r\nimport ShakeUtils from \"../../../core/utils/ShakeUtils\";\r\nimport GameBG from \"../../../game/GameBG\";\r\nimport DateUtils from \"../../../core/utils/DateUtils\";\r\nimport Game from \"../../../game/Game\";\r\nimport FlyUpTips from \"../../FlyUpTips\";\r\nimport Session from \"../../Session\";\r\nimport App from \"../../../core/App\";\r\nimport SysHero from \"../../sys/SysHero\";\r\nimport GameEvent from \"../../GameEvent\";\r\nimport MyEffect from \"../../../core/utils/MyEffect\";\r\nimport GuideManager, { Guide_Type } from \"../../guide/GuideManager\";\r\nimport NoResDialog, { NoResDialogType } from \"../../dialog/NoResDialog\";\r\nexport default class MainUI extends Laya.Box {\r\n    constructor() {\r\n        super();\r\n        this.height = GameBG.height;\r\n        this.width = 750;\r\n        this.topUI = new TopUI();\r\n        this.addChild(this.topUI);\r\n        Laya.stage.on(GameEvent.AD_UPDATE_POWER, this, this.onUpdatePower);\r\n        this.bottomUI = new BottomUI();\r\n        this.addChild(this.bottomUI);\r\n        this.bottomUI.y = 1334 - 122;\r\n        let img = new Laya.Image();\r\n        img.skin = \"main/jianhei.png\";\r\n        this.addChild(img);\r\n        img.width = 800;\r\n        img.anchorX = 0.5;\r\n        img.y = this.bottomUI.y - 50;\r\n        img.x = 375;\r\n        img.height = 50;\r\n        this.addChild(this.bottomUI);\r\n        this.mouseThrough = true;\r\n    }\r\n    onUpdatePower() {\r\n        this.topUI.removeSelf();\r\n        this.addChild(this.topUI);\r\n    }\r\n    appEnergy() {\r\n        this.topUI.appEnergy();\r\n    }\r\n    get selectIndex() {\r\n        return this.bottomUI.selectIndex;\r\n    }\r\n}\r\nexport class TopUI extends ui.test.mainUIUI {\r\n    constructor() {\r\n        super();\r\n        this._remainingTime = 0;\r\n        this.maskSpr = new Laya.Sprite();\r\n        this._isInit = false;\r\n        this.lastWidth = 0;\r\n        this.isTwo = false;\r\n        this.timerClip.visible = false;\r\n        this.appEnergyClip.visible = false;\r\n        this.headImg.skin = Game.userHeadUrl;\r\n        this.nameTxt.text = Game.userName;\r\n        this.on(Laya.Event.DISPLAY, this, this.onDis);\r\n        Laya.stage.on(GameEvent.WX_ON_SHOW, this, this.onDis);\r\n        this.jia.on(Laya.Event.CLICK, this, this.addTiFun);\r\n    }\r\n    addTiFun() {\r\n        let d = new NoResDialog();\r\n        d.setType(NoResDialogType.tili);\r\n        d.popup();\r\n    }\r\n    onDis() {\r\n        this.homeData = Session.homeData;\r\n        if (Date.now() >= this.homeData.lastTime) {\r\n            this._remainingTime = 0;\r\n        }\r\n        else {\r\n            let deltaTime = Session.homeData.lastTime - Date.now();\r\n            let time = Math.floor(deltaTime / 1000);\r\n            this._remainingTime = Math.floor(time % TopUI.TOTAL_TIME);\r\n            if (this._remainingTime == 0) {\r\n                this._remainingTime = TopUI.TOTAL_TIME;\r\n            }\r\n        }\r\n        this.updateEnergy();\r\n        this.dengji.value = \"\" + Session.homeData.playerLv;\r\n        this.coinClip.value = \"\" + Session.homeData.coins;\r\n        let sys = App.tableManager.getDataByNameAndId(SysHero.NAME, Session.homeData.battleLv);\r\n        let vv = Session.homeData.playerExp / sys.roleExp;\r\n        Laya.timer.frameLoop(1, this, this.onLoopExp, [vv]);\r\n        Laya.stage.on(GameEvent.GOLD_CHANGE, this, this.goldFun);\r\n    }\r\n    goldFun() {\r\n        this.coinClip.value = \"\" + Session.homeData.coins;\r\n    }\r\n    onLoopExp(vv) {\r\n        this.lastWidth += 15;\r\n        if (this.isTwo) {\r\n            if (this.lastWidth >= this.jingyantiao.width) {\r\n                this.lastWidth = 0;\r\n                this.isTwo = false;\r\n            }\r\n        }\r\n        else {\r\n            if (this.lastWidth >= this.jingyantiao.width * vv) {\r\n                this.lastWidth = this.jingyantiao.width * vv;\r\n                Laya.timer.clear(this, this.onLoopExp);\r\n            }\r\n        }\r\n        this.lastWidth = Math.max(1, this.lastWidth);\r\n        this.maskSpr.graphics.clear();\r\n        this.maskSpr.graphics.drawRect(0, 0, this.lastWidth, this.jingyantiao.height, \"#fff000\");\r\n        this.jingyantiao.mask = this.maskSpr;\r\n    }\r\n    appEnergy() {\r\n        if (this.homeData.curEnergy < TopUI.xiaohao) {\r\n            FlyUpTips.setTips(\"体力不足！\");\r\n            return;\r\n        }\r\n        Laya.MouseManager.enabled = false;\r\n        Game.isStartBattle = true;\r\n        this.homeData.curEnergy -= TopUI.xiaohao;\r\n        App.sendEvent(GameEvent.APP_ENERGY, TopUI.xiaohao);\r\n        this.updateEnergy();\r\n        Laya.timer.once(800, this, this.onStart);\r\n    }\r\n    onStart() {\r\n        Laya.MouseManager.enabled = true;\r\n        this._remainingTime = TopUI.TOTAL_TIME;\r\n        this.updateEnergy();\r\n        this.homeData.lastTime = Date.now() + (this.homeData.totalEnergy - this.homeData.curEnergy) * TopUI.TOTAL_TIME * 1000;\r\n        Session.saveData();\r\n        Game.battleLoader.load();\r\n    }\r\n    updateEnergy() {\r\n        this.tiliClip.value = this.homeData.curEnergy + \"/\" + this.homeData.maxEngergy;\r\n        let value = this.homeData.curEnergy / this.homeData.maxEngergy;\r\n        value = Math.max(0.1, value);\r\n        if (this.homeData.curEnergy < this.homeData.totalEnergy) {\r\n            Laya.timer.loop(1000, this, this.onLoop);\r\n            this.onLoop();\r\n        }\r\n        else {\r\n            this.timerClip.visible = false;\r\n            Laya.timer.clear(this, this.onLoop);\r\n        }\r\n    }\r\n    onLoop() {\r\n        this.timerClip.visible = true;\r\n        this.timerClip.value = DateUtils.getFormatBySecond3(this._remainingTime);\r\n        this._remainingTime--;\r\n        if (this._remainingTime < 0) {\r\n            this.homeData.curEnergy++;\r\n            if (this.homeData.curEnergy == this.homeData.totalEnergy) {\r\n                Laya.timer.clear(this, this.onLoop);\r\n                this.timerClip.visible = false;\r\n            }\r\n            else {\r\n                this._remainingTime = TopUI.TOTAL_TIME;\r\n            }\r\n            this.updateEnergy();\r\n        }\r\n    }\r\n}\r\nTopUI.TOTAL_TIME = 12 * 60;\r\nTopUI.MAX_ENERGY = 20;\r\nTopUI.xiaohao = 2;\r\nexport class BottomUI extends Laya.Box {\r\n    constructor() {\r\n        super();\r\n        this.bgBox = new Laya.Box();\r\n        this.curBg = new Laya.Image();\r\n        this.btnBox = new Laya.Box();\r\n        this.bgs = [];\r\n        this.btns = [];\r\n        this._selectIndex = 0;\r\n        this.opens = Session.homeData.openBtn;\r\n        this.size(750, 122);\r\n        this.addChild(this.bgBox);\r\n        this.curBg.skin = 'main/dazhao.png';\r\n        this.addChild(this.curBg);\r\n        this.addChild(this.btnBox);\r\n        for (let i = 0; i < 5; i++) {\r\n            let bg = new Laya.Image();\r\n            bg.skin = 'main/xiaobiao.png';\r\n            bg.width = 127;\r\n            bg.height = 122;\r\n            this.bgBox.addChild(bg);\r\n            bg.x = i * bg.width;\r\n            this.bgs.push(bg);\r\n            let btn = new Laya.Button();\r\n            this.makeBtn(btn);\r\n            btn.tag = this.opens[i];\r\n            if (this.opens[i] == \"1\") {\r\n                btn.stateNum = 2;\r\n                btn.width = 132;\r\n                btn.height = 136;\r\n                btn.skin = 'main/btn_' + i + '.png';\r\n                btn.y = bg.y + 55;\r\n            }\r\n            else {\r\n                btn.stateNum = 1;\r\n                btn.width = 38;\r\n                btn.height = 55;\r\n                btn.skin = 'main/suo.png';\r\n                btn.y = bg.y + 61;\r\n                btn.scale(1.2, 1.2);\r\n            }\r\n            this.btnBox.addChild(btn);\r\n            btn.anchorX = 0.5;\r\n            btn.anchorY = 0.5;\r\n            btn.x = bg.x + 63;\r\n            btn.clickHandler = new Laya.Handler(this, this.onClick, [btn]);\r\n            this.btns.push(btn);\r\n        }\r\n        this.onClick(this.btns[this._selectIndex], 10);\r\n        Laya.stage.on(GameEvent.RED_UPDATE, this, this.updateRed);\r\n        Laya.stage.on(GameEvent.GOLD_CHANGE, this, this.updateRed);\r\n        Laya.stage.on(GameEvent.PLAYER_INFO_UPDATE, this, this.updateRed);\r\n        this.updateRed();\r\n    }\r\n    updateRed() {\r\n        this.setBtn(this.btns[1], Session.heroData.canLvUp(), 1);\r\n        this.setBtn(this.btns[2], Session.talentData.canLvUp2(), 2);\r\n    }\r\n    setBtn(b, v, index) {\r\n        if (Session.homeData.openBtn[index] != \"1\") {\r\n            return;\r\n        }\r\n        let r = b.getChildByName(\"red\");\r\n        r.visible = v;\r\n        if (r.visible) {\r\n            r.ani1.play(0, true);\r\n        }\r\n    }\r\n    makeBtn(b) {\r\n        let r = new ui.test.RedPointViewUI();\r\n        r.scale(0.8, 0.8);\r\n        b.addChild(r);\r\n        r.name = \"red\";\r\n        r.pos(90, -20);\r\n        r.zOrder = 100;\r\n        r.visible = false;\r\n    }\r\n    updateBtns() {\r\n        let len = this.btns.length;\r\n        for (let i = 0; i < len; i++) {\r\n            let btn = this.btns[i];\r\n            btn.tag = this.opens[i];\r\n            if (this.opens[i] == \"1\") {\r\n                btn.stateNum = 2;\r\n                btn.width = 132;\r\n                btn.height = 136;\r\n                btn.scale(1, 1);\r\n                btn.skin = 'main/btn_' + i + '.png';\r\n            }\r\n            else {\r\n                btn.stateNum = 1;\r\n                btn.width = 38;\r\n                btn.height = 55;\r\n                btn.skin = 'main/suo.png';\r\n                btn.scale(1.2, 1.2);\r\n            }\r\n        }\r\n    }\r\n    open(v) {\r\n        let a = this.btns[v];\r\n        let t = new Laya.Tween();\r\n        t.to(a, { alpha: 0, scaleX: 4, scaleY: 4 }, 200, Laya.Ease.strongOut);\r\n    }\r\n    onClick(clickBtn, delay = 500) {\r\n        if (clickBtn.tag == \"-1\") {\r\n            clickBtn.mouseEnabled = false;\r\n            ShakeUtils.execute(clickBtn, 300, 2);\r\n            FlyUpTips.setTips(\"敬请期待\");\r\n            setTimeout(() => {\r\n                clickBtn.mouseEnabled = true;\r\n            }, 300);\r\n            return;\r\n        }\r\n        var ww = 0;\r\n        let tmp;\r\n        for (let i = 0; i < this.btns.length; i++) {\r\n            let btn = this.btns[i];\r\n            let bg = this.bgs[i];\r\n            bg.width = 127;\r\n            btn.selected = false;\r\n            if (btn == clickBtn) {\r\n                btn.selected = true;\r\n                bg.skin = 'main/dabiao.png';\r\n                bg.width = 242;\r\n                this._selectIndex = i;\r\n                tmp = bg;\r\n            }\r\n            bg.x = ww;\r\n            ww += bg.width;\r\n            btn.x = bg.x + bg.width * 0.5;\r\n        }\r\n        Laya.Tween.to(this.curBg, { x: tmp.x }, delay, Laya.Ease.cubicInOut);\r\n        Laya.stage.event(\"switchView\");\r\n    }\r\n    get selectIndex() {\r\n        return this._selectIndex;\r\n    }\r\n    fly(s, v) {\r\n        s.selected = false;\r\n        let t = new Laya.Tween();\r\n        let b = this.btns[v];\r\n        this.btns[v] = s;\r\n        Session.homeData.openBtn[v] = \"1\";\r\n        let p = b.localToGlobal(new Laya.Point(b.width / 2, b.height / 2));\r\n        t.to(s, { x: p.x, y: p.y }, 600, Laya.Ease.strongOut, new Laya.Handler(this, this.flyFun, [s, b, v]));\r\n    }\r\n    flyFun(s, b, flyNum) {\r\n        MyEffect.bigSmall(s, 3, 1);\r\n        b.parent.addChild(s);\r\n        s.pos(b.x, b.y);\r\n        this.makeBtn(s);\r\n        b.removeSelf();\r\n        s.clickHandler = new Laya.Handler(this, this.onClick, [s]);\r\n        if (Session.homeData.newStat == Guide_Type.click_talent) {\r\n            GuideManager.getInstance().hand(s, s.width / 2, s.height / 2, Guide_Type.talent_lv_up, 1000);\r\n        }\r\n        else if (Session.homeData.newStat == Guide_Type.open_role) {\r\n            GuideManager.getInstance().hand(s, s.width / 2, s.height / 2, Guide_Type.click_hp, 1000);\r\n        }\r\n        Laya.timer.once(1000, null, () => {\r\n            Laya.MouseManager.enabled = true;\r\n        });\r\n    }\r\n}\r\n",
  "references": [
    "D:/gitworker/GirlGunGame/src/ui/layaMaxUI.ts",
    "D:/gitworker/GirlGunGame/src/core/utils/ShakeUtils.ts",
    "D:/gitworker/GirlGunGame/src/game/GameBG.ts",
    "D:/gitworker/GirlGunGame/src/core/utils/DateUtils.ts",
    "D:/gitworker/GirlGunGame/src/game/Game.ts",
    "D:/gitworker/GirlGunGame/src/core/utils/DisplayUtils.ts",
    "D:/gitworker/GirlGunGame/src/main/FlyUpTips.ts",
    "D:/gitworker/GirlGunGame/src/game/data/HomeData.ts",
    "D:/gitworker/GirlGunGame/src/main/Session.ts",
    "D:/gitworker/GirlGunGame/src/net/SenderHttp.ts",
    "D:/gitworker/GirlGunGame/src/core/App.ts",
    "D:/gitworker/GirlGunGame/src/main/sys/SysHero.ts",
    "D:/gitworker/GirlGunGame/src/main/GameEvent.ts",
    "D:/gitworker/GirlGunGame/src/core/utils/MyEffect.ts",
    "D:/gitworker/GirlGunGame/src/main/guide/GuideManager.ts",
    "D:/gitworker/GirlGunGame/src/main/dialog/NoResDialog.ts"
  ]
}
