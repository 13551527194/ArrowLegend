{
  "code": "import GamePro from \"../GamePro\";\r\nimport GameProType from \"../GameProType\";\r\nimport Game from \"../Game\";\r\nimport PlaneGameMove from \"../move/PlaneGameMove\";\r\nimport HeroAI from \"../ai/HeroAI\";\r\nimport { GameAI } from \"../ai/GameAI\";\r\nimport HitEffect from \"../effect/HitEffect\";\r\nimport PlayerData from \"../data/PlayerData\";\r\nimport SysSkill from \"../../main/sys/SysSkill\";\r\nimport SysBuff from \"../../main/sys/SysBuff\";\r\nimport App from \"../../core/App\";\r\nimport WudiRotateScript from \"../controllerScript/WudiRotateScript\";\r\nimport BloodEffect from \"../effect/BloodEffect\";\r\nimport Session from \"../../main/Session\";\r\nexport default class Hero extends GamePro {\r\n    constructor() {\r\n        super(GameProType.Hero, 0);\r\n        this.playerData = new PlayerData();\r\n        this.isWudi = false;\r\n        this.isNew = true;\r\n        this.busi = false;\r\n        this.lastTime = 0;\r\n        this.reset();\r\n        this.unBlocking = true;\r\n        this.setGameMove(new PlaneGameMove());\r\n        this.setGameAi(new HeroAI());\r\n    }\r\n    addBuff(buffId) {\r\n        if (this.buffAry.indexOf(buffId) == -1) {\r\n            Game.buffM.addBuff(buffId, this);\r\n            this.buffAry.push(buffId);\r\n        }\r\n    }\r\n    lossBlood() {\r\n        return (this.gamedata.maxhp - this.gamedata.hp) / this.gamedata.maxhp;\r\n    }\r\n    changeBlood(sys) {\r\n        let buff = App.tableManager.getDataByNameAndId(SysBuff.NAME, sys.skillEffect1);\r\n        if (buff) {\r\n            if (sys.id == 4002 || sys.id == 4004) {\r\n                this.addBlood(Math.floor(Game.hero.gamedata.maxhp * buff.addHp / 1000));\r\n                return true;\r\n            }\r\n            else if (sys.id == 4003) {\r\n                this.changeMaxBlood(buff.hpLimit / 1000);\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n    changeMaxBlood(changeValue) {\r\n        if (changeValue > 0) {\r\n            this.gamedata.hp = this.gamedata.hp + Math.floor(this.gamedata.maxhp * changeValue);\r\n        }\r\n        this.gamedata.maxhp = Math.floor(this.gamedata.maxhp * (1 + changeValue));\r\n        if (this.gamedata.hp >= this.gamedata.maxhp) {\r\n            this.gamedata.hp = this.gamedata.maxhp;\r\n        }\r\n        this.initBlood(this.gamedata.hp);\r\n    }\r\n    addBlood(addValue) {\r\n        this.gamedata.hp = this.gamedata.hp + addValue;\r\n        this.gamedata.hp = Math.min(this.gamedata.hp, this.gamedata.maxhp);\r\n        this.initBlood(this.gamedata.hp);\r\n        BloodEffect.add(\"+\" + addValue, this._bloodUI, false, \"main/greenFont.png\");\r\n    }\r\n    updateAttackSpeed() {\r\n        console.log(\"修改攻速\");\r\n    }\r\n    reset() {\r\n        this.gamedata.hp = this.gamedata.maxhp = 600;\r\n        this.buffAry.length = 0;\r\n    }\r\n    resetAI() {\r\n        this.getGameAi().run = false;\r\n    }\r\n    setWudi(bool) {\r\n        if (this.isWudi == bool) {\r\n            return;\r\n        }\r\n        this.isWudi = bool;\r\n        if (bool) {\r\n            if (!this.wudi) {\r\n                let sp = Laya.loader.getRes(\"h5/bullets/skill/5009/monster.lh\");\r\n                if (sp) {\r\n                    this.wudi = sp;\r\n                    this.wudi.transform.localPositionY = -0.5;\r\n                    this.wudi.addComponent(WudiRotateScript);\r\n                }\r\n            }\r\n            this.sp3d.addChild(this.wudi);\r\n        }\r\n        else {\r\n            this.wudi && this.wudi.removeSelf();\r\n        }\r\n    }\r\n    init() {\r\n        if (Game.battleLoader.continueRes) {\r\n            Game.hero.gamedata.hp = Game.battleLoader.continueRes.curhp;\r\n            Game.hero.gamedata.maxhp = Game.battleLoader.continueRes.maxhp;\r\n            let skills = Game.battleLoader.continueRes.skills;\r\n            if (skills.length > 0) {\r\n                let arr = skills.split(\",\");\r\n                for (let i = 0; i < arr.length; i++) {\r\n                    let info = arr[i].split(\"_\");\r\n                    if (info.length == 2) {\r\n                        let sysSkill = App.tableManager.getDataByNameAndId(SysSkill.NAME, Number(info[0]));\r\n                        sysSkill.curTimes = Number(info[1]);\r\n                        Game.skillManager.addSkill(sysSkill);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        this.isDie = false;\r\n        this.setKeyNum(1);\r\n        this.acstr = \"\";\r\n        let sp = Laya.loader.getRes(\"h5/hero/hero.lh\");\r\n        Game.layer3d.addChild(sp);\r\n        var scale = 1.4;\r\n        sp.transform.localScale = new Laya.Vector3(scale, scale, scale);\r\n        this.setSp3d(sp);\r\n        this.play(\"Idle\");\r\n        this.pos2.x = this.pos2.z = 0;\r\n        this.sp3d.transform.localPositionX = 0;\r\n        this.sp3d.transform.localPositionY = 0;\r\n        console.log(\"出生位置\", Hero.bornX, Hero.bornY);\r\n        this.setXY2DBox(Hero.bornX, Hero.bornY);\r\n        this.initBlood(this.gamedata.hp);\r\n        this.addFootCircle();\r\n        Game.map0.Hharr.push(this.hbox);\r\n        this.gamedata.rspeed = 0;\r\n        this.rotation(90 / 180 * Math.PI);\r\n        this.onJumpDown();\r\n        Laya.stage.on(Game.Event_ADD_HP, this, this.addBlood);\r\n        Laya.stage.on(Game.Event_UPDATE_ATTACK_SPEED, this, this.updateAttackSpeed);\r\n        this.updateUI();\r\n    }\r\n    initBlood(hp) {\r\n        super.initBlood(hp, this.gamedata.maxhp);\r\n        this._bloodUI && this._bloodUI.pos(this.hbox.cx, this.hbox.cy - 120);\r\n    }\r\n    updateUI() {\r\n        super.updateUI();\r\n        this._bloodUI && this._bloodUI.pos(this.hbox.cx, this.hbox.cy - 120);\r\n        this._footCircle && this._footCircle.pos(this.hbox.cx, this.hbox.cy);\r\n        if (this._footCircle) {\r\n            this._footCircle.dir.rotation = this.face2d * 180 / Math.PI + 90;\r\n        }\r\n    }\r\n    onJumpDown() {\r\n        this.gamedata.rspeed = 20;\r\n        this.startAi();\r\n        Game.executor.start();\r\n        if (!Session.isGuide) {\r\n        }\r\n        console.log(\"主角调下来\", Game.AiArr.length);\r\n    }\r\n    hurt(hurt, isCrit) {\r\n        if (this.busi) {\r\n            return;\r\n        }\r\n        let isMiss = false;\r\n        let missSkill = Game.skillManager.isHas(5006);\r\n        if (missSkill) {\r\n            let missBuff = App.tableManager.getDataByNameAndId(SysBuff.NAME, missSkill.skillEffect1);\r\n            if (missBuff) {\r\n                let missRate = missBuff.addMiss / 1000;\r\n                if ((1 - Math.random()) > missRate) {\r\n                    isMiss = true;\r\n                    console.log(missSkill.skillName);\r\n                }\r\n            }\r\n        }\r\n        if (!isMiss) {\r\n            super.hurt(hurt, isCrit);\r\n            HitEffect.addEffect(this);\r\n        }\r\n        let angerSkill = Game.skillManager.isHas(3008);\r\n        if (angerSkill) {\r\n            let rate = (this.gamedata.maxhp - this.gamedata.hp) / this.gamedata.maxhp;\r\n            this.playerData.baseAttackPower = Math.floor(Game.skillManager.addAttack() * (1 + rate));\r\n        }\r\n    }\r\n    die() {\r\n        if (this.isDie) {\r\n            return;\r\n        }\r\n        this.isDie = true;\r\n        this.setKeyNum(1);\r\n        this.once(Game.Event_KeyNum, this, this.onDie);\r\n        setTimeout(() => {\r\n            this.play(GameAI.Die);\r\n        }, 300);\r\n    }\r\n    reborn() {\r\n        Game.rebornTimes--;\r\n        Game.skillManager.removeSkill(4005);\r\n        this.isDie = false;\r\n        this.setKeyNum(1);\r\n        this.acstr = \"\";\r\n        Game.hero.reset();\r\n        Game.hero.initBlood(Game.hero.gamedata.hp);\r\n        this.play(\"Idle\");\r\n        this.startAi();\r\n        Game.executor && Game.executor.start();\r\n        this.setWudi(true);\r\n        setTimeout(() => {\r\n            this.setWudi(false);\r\n        }, 2000);\r\n    }\r\n    onDie(key) {\r\n        let skill4005 = Game.skillManager.isHas(4005);\r\n        if (skill4005) {\r\n            setTimeout(() => {\r\n                this.reborn();\r\n            }, 800);\r\n            console.log(skill4005.skillName);\r\n        }\r\n        else {\r\n            this.stopAi();\r\n            Game.executor && Game.executor.stop_();\r\n            console.log(\"全部暂停\");\r\n            Laya.stage.event(Game.Event_MAIN_DIE);\r\n        }\r\n    }\r\n    pos2To3d() {\r\n        super.pos2To3d();\r\n        if (Laya.Browser.now() - this.lastTime >= 300) {\r\n            var runSmog = RunSmog.create(this.hbox.cx, this.hbox.cy);\r\n            Laya.Tween.to(runSmog, { scaleX: 0, scaleY: 0, alpha: 0 }, 600, null, new Laya.Handler(this, this.onClear, [runSmog]));\r\n            this.lastTime = Laya.Browser.now();\r\n        }\r\n    }\r\n    onClear(runSmog) {\r\n        RunSmog.recover(runSmog);\r\n    }\r\n}\r\nexport class RunSmog extends Laya.Image {\r\n    constructor() {\r\n        super();\r\n        this.skin = \"bg/renyan.png\";\r\n        this.size(64, 64);\r\n        this.anchorX = 0.5;\r\n        this.anchorY = 0.5;\r\n    }\r\n    static create(xx, yy) {\r\n        var smog = Laya.Pool.getItemByClass(RunSmog.flag, RunSmog);\r\n        smog.pos(xx, yy);\r\n        Game.footLayer.addChild(smog);\r\n        return smog;\r\n    }\r\n    static recover(smog) {\r\n        smog.removeSelf();\r\n        smog.alpha = 1;\r\n        smog.scale(1, 1);\r\n        Laya.Pool.recover(RunSmog.flag, smog);\r\n    }\r\n}\r\nRunSmog.flag = \"RunSmog\";\r\n",
  "references": [
    "D:/game01/Layabox/Game3DUP/src/game/GamePro.ts",
    "D:/game01/Layabox/Game3DUP/src/game/GameProType.ts",
    "D:/game01/Layabox/Game3DUP/src/game/Game.ts",
    "D:/game01/Layabox/Game3DUP/src/game/GameBG.ts",
    "D:/game01/Layabox/Game3DUP/src/game/move/PlaneGameMove.ts",
    "D:/game01/Layabox/Game3DUP/src/game/ai/HeroAI.ts",
    "D:/game01/Layabox/Game3DUP/src/game/ai/GameAI.ts",
    "D:/game01/Layabox/Game3DUP/src/game/effect/HitEffect.ts",
    "D:/game01/Layabox/Game3DUP/src/game/data/PlayerData.ts",
    "D:/game01/Layabox/Game3DUP/src/main/sys/SysSkill.ts",
    "D:/game01/Layabox/Game3DUP/src/main/sys/SysBuff.ts",
    "D:/game01/Layabox/Game3DUP/src/core/App.ts",
    "D:/game01/Layabox/Game3DUP/src/game/controllerScript/WudiRotateScript.ts",
    "D:/game01/Layabox/Game3DUP/src/game/effect/BloodEffect.ts",
    "D:/game01/Layabox/Game3DUP/src/main/Session.ts"
  ]
}
