{
  "code": "import Game from \"./Game\";\r\nimport SysBuff from \"../main/sys/SysBuff\";\r\nimport App from \"../core/App\";\r\nimport SysNpc from \"../main/sys/SysNpc\";\r\nimport BuffID from \"./buff/BuffID\";\r\nexport default class PlayerSkillManager {\r\n    constructor() {\r\n        this.skillList = [];\r\n        this.arrowHeadId = 0;\r\n        this.skinsHeads = [2001, 2002, 2003, 2004];\r\n        this.skinSkills = [5001, 5002, 5003, 5004, 5005, 5009];\r\n    }\r\n    clear() {\r\n        this.skillList.length = 0;\r\n        this.arrowHeadId = 0;\r\n    }\r\n    get skills() {\r\n        let ss = \"\";\r\n        for (let i = 0; i < this.skillList.length; i++) {\r\n            ss += \",\" + this.skillList[i].id + \"_\" + this.skillList[i].curTimes;\r\n        }\r\n        ss = ss.substring(1);\r\n        return ss;\r\n    }\r\n    addArrowHead(id) {\r\n        this.arrowHeadId = id;\r\n        Laya.loader.create([\"h5/bullets/skill/\" + id + \"/monster.lh\"]);\r\n    }\r\n    addSkill(data) {\r\n        if (this.skinsHeads.indexOf(data.id) != -1) {\r\n            this.addArrowHead(data.id);\r\n        }\r\n        if (data) {\r\n            let sys = this.isHas(data.id);\r\n            if (sys) {\r\n                if (sys.curTimes < sys.upperLimit) {\r\n                    sys.curTimes++;\r\n                }\r\n            }\r\n            else {\r\n                this.skillList.push(data);\r\n                data.curTimes++;\r\n            }\r\n            console.log(data.skillName, \"添加技能\");\r\n        }\r\n        if (this.skinSkills.indexOf(data.id) != -1) {\r\n            Laya.loader.create([\"h5/bullets/skill/\" + data.id + \"/monster.lh\"]);\r\n        }\r\n        if (data.id == BuffID.WUDI_5009) {\r\n            Game.hero.addBuff(BuffID.WUDI_5009);\r\n        }\r\n        this.addAttack();\r\n        this.addAttackSpeed();\r\n    }\r\n    addAttack() {\r\n        let buff;\r\n        Game.hero.playerData.baseAttackPower = 200;\r\n        let sys3002 = this.isHas(3002);\r\n        if (sys3002) {\r\n            buff = App.tableManager.getDataByNameAndId(SysBuff.NAME, sys3002.skillEffect1);\r\n            if (buff) {\r\n                Game.hero.playerData.baseAttackPower += sys3002.curTimes * buff.addAttack;\r\n            }\r\n        }\r\n        buff = null;\r\n        let sys3003 = this.isHas(3003);\r\n        if (sys3003) {\r\n            buff = App.tableManager.getDataByNameAndId(SysBuff.NAME, sys3003.skillEffect1);\r\n            if (buff) {\r\n                Game.hero.playerData.baseAttackPower += sys3003.curTimes * buff.addAttack;\r\n            }\r\n        }\r\n        return Game.hero.playerData.baseAttackPower;\r\n    }\r\n    addAttackSpeed() {\r\n        let buff;\r\n        Game.hero.playerData.attackSpeed = 650;\r\n        let sys3004 = this.isHas(3004);\r\n        if (sys3004) {\r\n            buff = App.tableManager.getDataByNameAndId(SysBuff.NAME, sys3004.skillEffect1);\r\n            if (buff) {\r\n                let rate = 1;\r\n                for (let i = 0; i < sys3004.curTimes; i++) {\r\n                    Game.hero.playerData.attackSpeed = Game.hero.playerData.attackSpeed * (1 - buff.addSpeed / 1000);\r\n                }\r\n            }\r\n        }\r\n        buff = null;\r\n        let sys3005 = this.isHas(3005);\r\n        if (sys3005) {\r\n            buff = App.tableManager.getDataByNameAndId(SysBuff.NAME, sys3005.skillEffect1);\r\n            if (buff) {\r\n                let rate = 1;\r\n                for (let i = 0; i < sys3005.curTimes; i++) {\r\n                    rate = rate * (buff.addSpeed / 1000);\r\n                }\r\n                Game.hero.playerData.attackSpeed = Game.hero.playerData.attackSpeed * (1 - rate);\r\n            }\r\n        }\r\n        return Game.hero.playerData.attackSpeed;\r\n    }\r\n    isHas(id) {\r\n        for (let i = 0; i < this.skillList.length; i++) {\r\n            if (this.skillList[i].id == id) {\r\n                return this.skillList[i];\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n    removeSkill(id) {\r\n        let sys = this.isHas(id);\r\n        if (sys) {\r\n            let index = this.skillList.indexOf(sys);\r\n            if (index >= 0) {\r\n                this.skillList.splice(index, 1);\r\n            }\r\n        }\r\n    }\r\n    getRotateSkills() {\r\n        let skillIds = [5001, 5002, 5003, 5004];\r\n        let rt = [];\r\n        for (let i = 0; i < skillIds.length; i++) {\r\n            if (this.isHas(skillIds[i])) {\r\n                rt.push(skillIds[i]);\r\n            }\r\n        }\r\n        return rt;\r\n    }\r\n    getRandomSkillByNpcId(npcId) {\r\n        let sysNpc = App.tableManager.getDataByNameAndId(SysNpc.NAME, npcId);\r\n        let ary = sysNpc.skillRandom.split(\",\");\r\n        for (let i = 0; i < this.skillList.length; i++) {\r\n            let sys = this.skillList[i];\r\n            if (sys) {\r\n                if (sys.curTimes >= sys.upperLimit) {\r\n                    let flag = ary.indexOf(sys.id + \"\");\r\n                    if (flag != -1) {\r\n                        ary.splice(flag, 1);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        let rand = Math.floor(Math.random() * ary.length);\r\n        return Number(ary[rand]);\r\n    }\r\n}\r\n",
  "references": [
    "D:/gitworker/Game3DUP/src/main/sys/SysSkill.ts",
    "D:/gitworker/Game3DUP/src/game/Game.ts",
    "D:/gitworker/Game3DUP/src/main/sys/SysBuff.ts",
    "D:/gitworker/Game3DUP/src/core/App.ts",
    "D:/gitworker/Game3DUP/src/main/sys/SysNpc.ts",
    "D:/gitworker/Game3DUP/src/game/buff/BuffID.ts"
  ]
}
