{
  "code": "import GamePro from \"../GamePro\";\r\nimport GameProType from \"../GameProType\";\r\nimport SysEnemy from \"../../main/sys/SysEnemy\";\r\nimport Game from \"../Game\";\r\nimport { GameAI } from \"../ai/GameAI\";\r\nimport { ui } from \"./../../ui/layaMaxUI\";\r\nimport MoveType from \"../move/MoveType\";\r\nimport AttackType from \"../ai/AttackType\";\r\nimport App from \"../../core/App\";\r\nimport SysBullet from \"../../main/sys/SysBullet\";\r\nimport MonsterShader from \"./MonsterShader\";\r\nimport DieEffect from \"../effect/DieEffect\";\r\nimport HitEffect from \"../effect/HitEffect\";\r\nimport MonsterBoomEffect from \"../effect/MonsterBoomEffect\";\r\nimport SysBuff from \"../../main/sys/SysBuff\";\r\nimport GameBG from \"../GameBG\";\r\nimport MemoryManager from \"../../main/scene/battle/MemoryManager\";\r\nimport GameEvent from \"../../main/GameEvent\";\r\nexport default class Monster extends GamePro {\r\n    constructor() {\r\n        super(GameProType.RockGolem_Blue, 0);\r\n        this._bulletShadow = new ui.test.BulletShadowUI();\r\n        Game.footLayer.addChild(this._bulletShadow);\r\n    }\r\n    onCie() {\r\n        if (!this.isIce) {\r\n            this.isIce = true;\r\n            this.animator.speed = 0;\r\n        }\r\n    }\r\n    offCie() {\r\n        if (this.isIce) {\r\n            this.isIce = false;\r\n            this.animator.speed = 1;\r\n        }\r\n    }\r\n    startAi() {\r\n        super.startAi();\r\n    }\r\n    stopAi() {\r\n        super.stopAi();\r\n    }\r\n    setShadowSize(ww) {\r\n        super.setShadowSize(ww);\r\n        Game.footLayer.addChild(this._bulletShadow);\r\n    }\r\n    updateUI() {\r\n        super.updateUI();\r\n        this._bulletShadow && this._bulletShadow.pos(this.hbox.cx - (this._bulletShadow.img.width - GameBG.mw) * 0.5, this.hbox.cy - (this._bulletShadow.img.height - GameBG.mw) * 0.5);\r\n    }\r\n    init() {\r\n        let sysBullet;\r\n        if (this.sysEnemy.normalAttack > 0) {\r\n            sysBullet = App.tableManager.getDataByNameAndId(SysBullet.NAME, this.sysEnemy.normalAttack);\r\n            this.aiType = sysBullet.bulletType;\r\n        }\r\n        if (this.sysEnemy.skillId != '0') {\r\n            var arr = this.sysEnemy.skillId.split(',');\r\n            for (var m = 0; m < arr.length; m++) {\r\n                let id = Number(arr[m]);\r\n                if (id > 0) {\r\n                    sysBullet = App.tableManager.getDataByNameAndId(SysBullet.NAME, id);\r\n                    this.aiType = sysBullet.bulletType;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    show() {\r\n        Game.layer3d.addChild(this.sp3d);\r\n        Game.bloodLayer.addChild(this._bloodUI);\r\n        Game.footLayer.addChild(this._bulletShadow);\r\n    }\r\n    hide() {\r\n        this.sp3d && this.sp3d.removeSelf();\r\n        this._bloodUI && this._bloodUI.removeSelf();\r\n        this._bulletShadow && this._bulletShadow.removeSelf();\r\n    }\r\n    initBlood(hp) {\r\n        super.initBlood(hp, hp);\r\n        this._bloodUI && this._bloodUI.pos(this.hbox.cx, this.hbox.cy - 90);\r\n    }\r\n    hurt(hurt, isCrit, isBuff = false) {\r\n        super.hurt(hurt, isCrit);\r\n        if (this.sysEnemy.isBoss) {\r\n            Laya.stage.event(GameEvent.BOOS_BLOOD_UPDATE, hurt);\r\n        }\r\n        if (isBuff) {\r\n            return;\r\n        }\r\n        HitEffect.addEffect(this);\r\n        MonsterBoomEffect.addEffect(this, this.tScale);\r\n    }\r\n    die() {\r\n        this.setKeyNum(1);\r\n        this.once(Game.Event_KeyNum, this, this.onDie);\r\n        this.play(GameAI.Die);\r\n        if (Game.map0.Eharr.indexOf(this.hbox) >= 0) {\r\n            Game.map0.Eharr.splice(Game.map0.Eharr.indexOf(this.hbox), 1);\r\n        }\r\n        if (Game.hero.playerData.level <= 10) {\r\n            if (this.sysEnemy.dropExp > 0) {\r\n                let skill3001 = Game.skillManager.isHas(3001);\r\n                let addNum = 0;\r\n                if (skill3001) {\r\n                    console.log(skill3001.skillName);\r\n                    let buff3001 = App.tableManager.getDataByNameAndId(SysBuff.NAME, skill3001.skillEffect1);\r\n                    addNum = Math.ceil(this.sysEnemy.dropExp * buff3001.addExp / 1000);\r\n                }\r\n                Game.hero.playerData.exp += this.sysEnemy.dropExp + addNum;\r\n            }\r\n        }\r\n        let skill4001 = Game.skillManager.isHas(4001);\r\n        if (skill4001) {\r\n            let buff4001 = App.tableManager.getDataByNameAndId(SysBuff.NAME, skill4001.skillEffect1);\r\n            Game.hero.addBlood(Math.floor(Game.hero.gamedata.maxhp * buff4001.addHp / 1000));\r\n            console.log(skill4001.skillName);\r\n        }\r\n    }\r\n    onDie(key) {\r\n        Game.selectHead.removeSelf();\r\n        Game.selectFoot.removeSelf();\r\n        this.stopAi();\r\n        this._bulletShadow && this._bulletShadow.removeSelf();\r\n        this.sp3d && this.sp3d.removeSelf();\r\n        Laya.Pool.recover(Monster.TAG + this.sysEnemy.enemymode, this);\r\n        DieEffect.addEffect(this);\r\n        MemoryManager.ins.app(this.sp3d.url);\r\n    }\r\n    clear() {\r\n        Game.selectHead.removeSelf();\r\n        Game.selectFoot.removeSelf();\r\n        this.stopAi();\r\n        this._bulletShadow && this._bulletShadow.removeSelf();\r\n        this.sp3d && this.sp3d.removeSelf();\r\n        Laya.Pool.recover(Monster.TAG + this.sysEnemy.enemymode, this);\r\n        MemoryManager.ins.app(this.sp3d.url);\r\n    }\r\n    static getMonster(enemyId, xx, yy, mScale, hp) {\r\n        let sysEnemy = App.tableManager.getDataByNameAndId(SysEnemy.NAME, enemyId);\r\n        let now = Game.executor.getWorldNow();\r\n        if (!MonsterShader.map[sysEnemy.enemymode]) {\r\n            MonsterShader.map[sysEnemy.enemymode] = new MonsterShader(Laya.loader.getRes(\"h5/monsters/\" + sysEnemy.enemymode + \"/monster.lh\"));\r\n        }\r\n        if (!hp) {\r\n            hp = sysEnemy.enemyHp;\r\n            if (sysEnemy.skillId != '0') {\r\n                var arr = sysEnemy.skillId.split(',');\r\n                for (var m = 0; m < arr.length; m++) {\r\n                    let id = Number(arr[m]);\r\n                    if (id > 0) {\r\n                        let sysBullet = App.tableManager.getDataByNameAndId(SysBullet.NAME, id);\r\n                        if (sysBullet.bulletType == AttackType.SPLIT) {\r\n                            hp = sysEnemy.enemyHp / sysBullet.splitNum;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        let tag = Monster.TAG + sysEnemy.enemymode;\r\n        Game.poolTagArr[tag] = tag;\r\n        var gpro = Laya.Pool.getItemByClass(tag, Monster);\r\n        gpro.curLen = gpro.moveLen = 0;\r\n        gpro.sysEnemy = sysEnemy;\r\n        gpro.init();\r\n        if (!gpro.sp3d) {\r\n            var sp = Laya.Sprite3D.instantiate(Laya.loader.getRes(\"h5/monsters/\" + sysEnemy.enemymode + \"/monster.lh\"));\r\n            MemoryManager.ins.add(sp.url);\r\n            gpro.setSp3d(sp, GameBG.ww * 0.8);\r\n            console.log(\"克隆一个怪\");\r\n        }\r\n        gpro.hurtValue = sysEnemy.enemyAttack;\r\n        if (sysEnemy.moveType > 0) {\r\n            var MOVE = Laya.ClassUtils.getClass(MoveType.TAG + sysEnemy.moveType);\r\n            gpro.setGameMove(new MOVE());\r\n        }\r\n        let tScale = sysEnemy.zoomMode / 100;\r\n        tScale = mScale ? mScale : tScale;\r\n        gpro.tScale = tScale;\r\n        gpro.sp3d.transform.scale = new Laya.Vector3(tScale, tScale, tScale);\r\n        Game.map0.Eharr.push(gpro.hbox);\r\n        Game.map0.Fharr.push(gpro.hbox);\r\n        gpro.setShadowSize(sysEnemy.zoomShadow);\r\n        gpro.setXY2DBox(xx, yy);\r\n        gpro.initBlood(hp);\r\n        var MonAI = Laya.ClassUtils.getClass(AttackType.TAG + sysEnemy.enemyAi);\r\n        console.log(\"当前怪的AI\", sysEnemy.id, sysEnemy.enemymode, sysEnemy.txt, sysEnemy.enemyAi, MonAI);\r\n        if (MonAI == null) {\r\n            console.log('没有这个怪的AI', sysEnemy.id);\r\n        }\r\n        gpro.setGameAi(new MonAI(gpro));\r\n        gpro.startAi();\r\n        Game.layer3d.addChild(gpro.sp3d);\r\n        console.log(\"ai的长度\", Game.AiArr.length);\r\n        return gpro;\r\n    }\r\n}\r\nMonster.TAG = \"Monster_\";\r\n",
  "references": [
    "D:/gitworker/Game3DUP/src/game/GamePro.ts",
    "D:/gitworker/Game3DUP/src/game/GameProType.ts",
    "D:/gitworker/Game3DUP/src/main/sys/SysEnemy.ts",
    "D:/gitworker/Game3DUP/src/game/Game.ts",
    "D:/gitworker/Game3DUP/src/game/ai/GameAI.ts",
    "D:/gitworker/Game3DUP/src/ui/layaMaxUI.ts",
    "D:/gitworker/Game3DUP/src/game/move/MoveType.ts",
    "D:/gitworker/Game3DUP/src/game/ai/AttackType.ts",
    "D:/gitworker/Game3DUP/src/core/App.ts",
    "D:/gitworker/Game3DUP/src/game/move/JumpMove.ts",
    "D:/gitworker/Game3DUP/src/game/move/FlyGameMove.ts",
    "D:/gitworker/Game3DUP/src/main/sys/SysBullet.ts",
    "D:/gitworker/Game3DUP/src/game/player/MonsterShader.ts",
    "D:/gitworker/Game3DUP/src/game/effect/DieEffect.ts",
    "D:/gitworker/Game3DUP/src/game/effect/HitEffect.ts",
    "D:/gitworker/Game3DUP/src/game/effect/MonsterBoomEffect.ts",
    "D:/gitworker/Game3DUP/src/game/ai/ArcherAI.ts",
    "D:/gitworker/Game3DUP/src/main/sys/SysSkill.ts",
    "D:/gitworker/Game3DUP/src/main/sys/SysBuff.ts",
    "D:/gitworker/Game3DUP/src/game/ai/BaseAi.ts",
    "D:/gitworker/Game3DUP/src/game/GameBG.ts",
    "D:/gitworker/Game3DUP/src/main/scene/battle/MemoryManager.ts",
    "D:/gitworker/Game3DUP/src/main/GameEvent.ts"
  ]
}
